<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
	<div layout:fragment="content">
	
		<!-- 상단 내비 / 타이틀 -->
		<div class="d-sm-flex align-items-center justify-content-between">
			<span class="mb-0 text-gray-600"><i class="fas fa-fw fa-home"></i> &gt; BASIC &gt; 데이터 Lifcycle</span>
		</div>
		<div class="d-sm-flex align-items-center justify-content-between mb-4">
			<h1 class="col_grey font_23">Lifecycle 항목 관리</h1>
		</div>
	
		<!-- 영역 -->
		<div class="row">
			<div class="col-lg mb-4">
				<!-- 조회 영역 -->
				<div class="card shadow mb-4">
					<div class="input_table">
						<table>
							<caption>패턴/지표 목록을 구분명, 패턴/지표명으로 검색할 수 있는 기능.</caption>
							<colgroup>
								<col style="width:15%">
								<col style="width:10%">
								<col style="width:35%">
								<col style="width:15%">
								<col style="width:10%">
								<col style="width:15%">
							</colgroup>
							<tbody>
								<tr>
									<th>
										<label for="type2">분류</label>
									</th>
									<td>
										<input type="text" name="cl" id="cl" title="분류" maxlength="100" placeholder="입력">
									</td>
									<th>
										<label for="type2">항목명</label>
									</th>
									<td>
										<input type="text" name="fieldNm" id="fieldNm" title="항목명" maxlength="100" placeholder="입력">
									</td>
									<td>
									<button class='btn btn-primary wd_50' type='button' onclick="fn_changSearch();" >조회</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<!-- 
					<div style="text-align: center; padding: 10px;">
						<button class='btn btn-primary wd_50' type='button' style="width:150px;" onclick="fn_changSearch();" >조회</button>
					</div>
					 -->
				</div>
				
				<!-- 내용 -->
				<div class="card shadow mb-4">
                   <div class="card-body">
                   	<input type="hidden" id="itemsPerPage" name="itemsPerPage" value="10"/>
                   	<input type="button" class="btn btn-primary mgn_b20" id="saveBtn" value="저장" onclick="fn_saveAt(this)" style="width:76px; float: right;">
                       <div id="tab1_div" align="right" class="card-body">
							<button class='btn btn-primary mgn_b20' type='button' onclick="fn_openIndexLayer('INS', '');">신규 등록</button>
							<button class='btn btn-primary mgn_b20' type='button' onclick="fn_openCSVLayer('INS', '');">CSV 파일 등록</button>
						</div>
                       <!-- 신규 지표 등록 팝업 open -->
						<div id="indexInsLayer" class="layer_pop_wrap">
							<div class="txt_right mgn_b10">
							    <a href="javascript:fn_modalCloseLayer();" class="btn_close"><img src="/img/icon/icon_close.png" alt="닫기 버튼"></a>
							</div>
							<div class="layer_pop" style="height: 500px;">
								<div class="layer_header">
								    <p>지표 등록</p>
								</div>
								<section class="l_box_type02">
									<div style="width: 860px;">
										<form id="indexSave">
											<input type="hidden" id="uInsMode" 	 name="uInsMode"   value="">
											<input type="hidden" id="uSubmitChk" name="uSubmitChk" value="">
					                        <input type="hidden" id="anals" 	 name="anals"  	   value="AG000700">
					                        <div class="tb_type05">
												<table>
													<tbody>
														<tr>
															<th><label id="cl">분류</label></th>
																<td colspan="3"><input type="text" id="cl" name="cl" maxlength="20" value="라이프사이클" readonly></td> 
														</tr>
														<tr>
															<th>항목명</th>
														 	<td colspan="3"><input type="text" id="fieldNm" name="fieldNm" maxlength="20"></td>
														</tr>
														<tr>
															<th>기간</th>
															<td>
																<input type="text" id="period" name="period" maxlength="20"/>
															</td>
															<td>
																<label class='switch'><input type='checkbox' class='month' id='month' data-name='month' name='month'/><span class='slider round'></span>개월</label>
															</td>
															<td>
																<label class='switch'><input type='checkbox' class='year' id='year' data-name='year' name='year'/><span class='slider round'></span>년</label>
															</td>
														</tr>
														<tr>
															<th>설명</th>
															<td colspan="3">
				                                                <textarea type="text" id="rm" name="rm" th:value="${rm}" th:text="${rm}"></textarea>
				                                            </td>
														</tr>
													</tbody>
												</table>
											 </div>
										</form>
										
										<div class="btn_modal_box">
											<p class="l_box_type02_p">
												<span><button class="btn btn-primary" type="button"  onclick="fn_saveIndex(this);">저장</button></span>
											</p>
							        	</div>
									</div>
								</section>
				           	</div>
						</div>
						<!-- 신규 지표 등록 팝업 close -->	
                       <div id ="grid" class="tb_type99" style="clear: both;" ></div>
                       <div id="pagination" class="tui-pagination"></div>
                   </div>
	            </div>
	            <div id="div_2" class="card shadow mb-4" >
					<div class="card-body table_type100">
	            		<table id="dataTable" class="table table-striped table-bordered"></table>
	            	</div>
	            </div>
			</div>
		</div>
	
	
		<script th:inline="javascript" class="code-js">
		
			var sessionCon = /*[[ ${sessionCon} ]]*/;
			var sessionDbmsKnd = /*[[ ${conType} ]]*/;
			var dataList = {};
			var aJsonArray = [];
			var updateCnt = 0;
			var dbmsKnd = "";
			
			// 페이지 로드시 적용 설정
			$(document).ready(function() {
		
				fn_search();
				
			});
			
		
			
			function fn_changSearch(){
				$('#pageIndex').val('');
				fn_search();
			}
			
			// 목록 정보를 Ajax를 이용하여 가지고 온다.
			function fn_search(){
			
				var insttData = null;
				var pageIndex = $('#pageIndex').val();
				var searchValue = $('#searchValue').val();
				var searchType = $('#searchType').val();
				var itemsPerPage = $("#itemsPerPage").val();
				
				if($('#dbmsKnd').val() != null){
					dbmsKnd = $('#dbmsKnd').val();
				}
				if(dbmsKnd == '' || dbmsKnd == null){
					dbmsKnd = "Oracle";
				}
								
				if(dbmsKnd != sessionDbmsKnd){
					$("#saveBtn").hide();
				}else{
					$("#saveBtn").show();
				}
				
				var params = {
					"searchValue" : searchValue,
					"searchType" : searchType,
					"dbmsKnd" : dbmsKnd,
					"pageIndex" : pageIndex,
					"itemsPerPage" : itemsPerPage
				}
			
				$.ajax({
					url: '/mngr/basicInfo/selectLifecycle',
					data: params,
					success: function(data){
						var obj = JSON.parse(data);
						
						var dataList = obj.result;
						var totalCnt = obj.totalCnt;
						//dataTalbe(obj);
						fn_setGrid(dataList);
						
						/* 페이징 function 호출 */
						fn_pagination(totalCnt);
					}
				});
			}
			
			// 조회 목록 리스트를 그리드 형식으로 화면 구성 한다.
			function fn_setGrid(data){
				$("#grid").empty();
				// 조회 컬럼 목록
				var columns = [
					{header: 'NO',		name: 'groupNm',	whiteSpace: 'pre-line', sortable: true,  width:120, align:'center' },
					{header: '분류',		name: 'anals', 		whiteSpace: 'pre-line', sortable: true,  width:100, align:'center' },
					{header: '항목명',	name: 'fieldNm',	whiteSpace: 'pre-line', sortable: true,  width:150, align:'center' }, 	 
					{header: '기간',		name: 'period', 	whiteSpace: 'pre-line', sortable: true,  width:500, align:'left'},
					{header: '설명',		name: 'rm', 		whiteSpace: 'pre-line', sortable: true,  align:'left', resizable: false}
					
				];
				
				const grid = new tui.Grid({
					el : document.getElementById("grid"),
					data : data,
					scrollX : false,
					scrollY : false,
					bodyHeight : 'auto',
					rowHeight : 'auto',
					minBodyHeight : 40,
					header: {
					  height: 40
					},
					columns : columns,
					columnOptions: {
					      resizable: true
					    }
				});
				
				const extOptions = {
					cell: {
						focused: {
				            border: 0 // 선택 셀 강조 표시 x
				        }
					}
				};
				
				tui.Grid.applyTheme('default', extOptions);
				
				grid.resetData(data);
			}
			
			function dataTalbe(obj){
				
				var analsList = obj.analsList;
				var analsGroup = obj.analsGroup;
		
				// COLUMNS 리스트
				var columnsArr = [
					{ name: 'first', title: 'NO'},
					{ name: 'second', title: '분류'},
			        { name: 'third', title: '항목명'},
			        { title: '기간'},
			        { title: '설명'}
				];
				
				// DATA 리스트 
				var dataListArr = [];
				
				// 체크박스 데이터
				$.each(analsList, function(index, value2) {
					var analsArr = [];
					if(value2.pttrnSeNm == undefined){
						value2.pttrnSeNm = '&nbsp;';
					}
					
					analsArr.push(value2.groupNm);
					analsArr.push(value2.pttrnSeNm);	// 그룹 명 추가
					analsArr.push(value2.analsNm);
					analsArr.push(value2.analsfrmla);
					analsArr.push(value2.rm);
					//analsArr.push(value2.useat);
					if(value2.useat == 1)	{
						analsArr.push("<label class='switch'><input type='checkbox' class='chkItem' data-name='chkItem' name='chkItem' data-value='UDT' checked/><span class='slider round'></span></label>");
						
					}else if(value2.useat == 0){
						analsArr.push("<label class='switch'><input type='checkbox' class='chkItem' data-name='chkItem' name='chkItem' data-value='UDT'/><span class='slider round'></span></label>");
					}
					//analsArr.push(value2.groupcode);
					var html  = "";
					var groupCode = value2.groupcode;
					var groupId = groupCode.substring(0,6);
					if(groupId == 'AG0004' || groupId == 'AG0005' || groupId == 'AG0006' ){
						if($('#dbmsKnd').val() == sessionDbmsKnd)
							analsArr.push("<input type='button' class='btn_select' data-value='UDT' data-backdrop='static' data-keyboard='false' value='수정'/>");
					}
					

					dataListArr.push(analsArr);
				})
				
				var data = dataListArr;
				var columnDefsArr = [
					{"targets": [0, 1, 2], "class" : "fixColums"}
				];
				
				table = $('#dataTable').DataTable({
					destroy : true,
					retrieve : false,
					columns: columnsArr,
					data: data,
					rowsGroup: [
					  'first:name',
					  'second:name',
					  'third:name'
					],
		    		//pageLength: '20',
					scrollY:        800,
					scrollX:        true,
					scrollCollapse: false,
					searching: false,			// 검색 영역
					paging:         false,	// 페이징 표시
					info : false,				// 페이지 건수 표시 
					ordering: false,			// 정렬 제거
					orderCellsTop: false,
					//autoWidth: false,
					fixedColumns: {
						leftColumns: 3
					},
					columnDefs : columnDefsArr
				});
				
			};
			
			
			function fn_openIndexLayer(mode, item){
				
				/*레이어 열기*/
			    $('#indexInsLayer').addClass('on');
			    
			    $('.layer_pop_wrap').css("left","30%");
			    $('.layer_pop_wrap').css("top","55%");
				
			    $('.tui-grid-container').css('z-index', 1);			// 
			    $('.cover').show();
				
				// 폼 초기화
				$("#manageInsFrm")[0].reset();
				$("#anals").text("분류");
				$("#uIdChk").css("color", "#858796");
				
				$("#uId").change(function() {

					var userId = $("#uId").val(); 
					
					$.ajax({
						type : 'post',
						url : '/mngr/selectUserIdChk',
						data : {'userId' : userId},
						datatype:'json',
						success : function(data){
							var obj = $.parseJSON(data);
							var result = obj.result;
						
						}, error:function() {
							alert("처리중 에러가 발생하였습니다");
							return;
						}
				    });
				});
			}
			
			function fn_saveIndex(obj){
				var frm = $("#indexSave").serialize();
				
				$.ajax({
					url: "/mngr/basicInfo/indexSave",
					type: 'POST',
					data: $("#indexSave").serialize(),
					success: function(data){
						var result = JSON.parse(data);
						var resultCnt = result.resultCnt;
			
						if(resultCnt == 1){
							alert("저장 되었습니다.");
							fn_modalClose();
							
						}else if(resultCnt == 0){
							alert("저장이 실패하였습니다.");
						}
						location.reload(true);
					}
				});
				
			}
			
		</script>	
	

	</div>
	
</html>