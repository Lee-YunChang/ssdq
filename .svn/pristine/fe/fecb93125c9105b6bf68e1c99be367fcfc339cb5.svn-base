<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
	<div layout:fragment="content">
	
		<!-- 상단 내비 / 타이틀 -->
		<div class="d-sm-flex align-items-center justify-content-between mgn_b0">
			<span class="col_gray01 font_14 mgn_b0"><img src="/img/icon/icon_home.png" alt="집 아이콘" class="vtc_unset"> PROPERTIES  &gt; 공통정보 &gt; 메뉴권한관리 </span>
		</div>
                 
		<div class="d-sm-flex align-items-center justify-content-between mb-4">
			<h1 class="col_grey font_23 font_slim"></i> 메뉴권한관리</h1>
		</div>

		<!-- 영역 -->
		<div class="row">
			<div class="col-lg-3 mb-4">
				<!-- 조회 영역 -->
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">권한목록</h6>
					</div>
					<div class="card-body">
						<div id ="div1" class="table-responsive">
							<table class="table table-bordered tb_type98" id="dataTable" width="100%" cellspacing="0">
								<thead>
									<tr class="tr_titles">
										<th>권한코드</th>
										<th>권한 명</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="author : ${authorList}">
										<td class="tdLink" th:onclick="javascript:fn_authListToObj(this)" th:text="${author.authorCode }" ></td>
										<td th:text="${author.authorCodeNm }" ></td>
									</tr>
								</tbody>
							</table>
						</div>
						
						<div class="tb_type98" style="margin-top: 20px; width: 300px;">
							<div class="col-sm-4 text-center" style="float: left;">
								<button class="btn btn-success btn-block" type="button" onclick="fn_saveAuth();" style="width: 100px;">권한 저장</button>
							</div>
						</div>
				
					</div>
				</div>
			</div>
			
			<div class="col mb-4">
				<!-- 조회 영역 -->
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary"><span id="authNm"></span>_메뉴 권한 리스트</h6>
					</div>
					<div class="card-body">
						<div id ="div1" class="table-responsive">
							<table class="table table-bordered tb_type98" id="dataTable" width="100%" cellspacing="0">
								<colgroup>
									<col style="width: 15%;" />
									<col style="width: 85%;" />
								</colgroup>
								<thead>
									<tr class="tr_titles">
										<th>권한여부</th>
										<th>메뉴 명</th>
									</tr>
								</thead>
								<tbody id="authList">
									
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript"  class="code-js" th:inline="javascript">
		
		var authChk = false;

		$(document).ready(function(){
			
			$('#authList').on('click','input', function(e){
				
				authChk = true;
				
				if($(this).attr("data-lv") == "1") {
					// 1뎁스 선택시 하위 모두 선택 처리
					var menuGroupSn = $(this).attr("data-menuGroupSn");
					var selectd = $('#authList').children('tr').children('td').children('label.switch').children('.chkItem[data-menuGroupSn='+menuGroupSn+']');
					
					if($(this).is(":checked")) {
						selectd.prop("checked", true);
					} else {
						selectd.prop("checked", false);
					}
				}
				
				if($(this).attr("data-lv") == "2") {
					// 2뎁스 선택시 하위 모두 선택 처리
					var menuGroupSn = $(this).attr("data-menuGroupSn");
					var menuSn = $(this).attr("data-menuSn");
					
					var selectd = $('#authList').children('tr').children('td').children('label.switch').children('.chkItem[data-upperMenuSn='+menuSn+']');
					
					if($(this).is(":checked")) {
						selectd.prop("checked", true);
					} else {
						selectd.prop("checked", false);
					}
				}
			});
			
		});

		function fn_authListToObj(obj){
			var authCode = $(obj).text();
			fn_authList(authCode);
		}

		function fn_authList(authCode){
						
			$("#authNm").text(authCode);
			
			$.ajax({
				url : "/mngr/menuMng/selectUserAuthMenuList",
				method : "POST",
				data : {"authCode" : authCode},
				success : function(data) {
					if (data) {
						var obj = JSON.parse(data);
						var item = obj.result;
						
						$("#authList").empty();
						
						var html = "";
						var groupBy = 1;
						
						$.each(item, function(index, value) {
							
							if(groupBy == value.menuGroupSn){
								
								html += "<tr>";
								if(value.authAt != 'Y'){
									html += "<td  class='authTd'>";
									html += "<label class='switch'>";
									if(value.menuGroupSn != 1){
										html += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-lv='1'><span class='slider round'></span>";
									}else{
										if(authCode == 'ROLE_ADMIN'){
											html += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-lv='1' disabled><span class='slider round'></span>";	
										}else{
											html += "";
										}
									}
									html += "</label>";
									html += "</td>";
								}else{
									html += "<td  class='authTd'>";
									html += "<label class='switch'>";
									if(value.menuGroupSn != 1){
										html += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-lv='1' checked><span class='slider round'></span>";
									}else{
										if(authCode == 'ROLE_ADMIN'){
											html += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-lv='1' checked disabled><span class='slider round'></span>";	
										}else{
											html += "";
										}
									}
									html += "</label>";
									html += "</td>";	
								}
								
								html += "	<td>"+value.menuGroupNm+" (전체 선택)</td>";
								html += "</tr>";
								html += fn_trList(item, value.menuGroupSn, authCode);
								groupBy++;
							}
						
						});
						
						$("#authList").append(html);
					}
				}
			});
			
		}

		function fn_trList(item, menuGroupSn, authCode){
			var cHtml = "";

			$.each(item, function(index, value) {
			
				if(menuGroupSn == value.menuGroupSn && value.upperMenuSn == 0){
					
					cHtml += "<tr>";
					
					if(value.authAt != 'Y'){
						cHtml += "<td  class='authTd'>";
						cHtml += "<label class='switch'>";
							if(value.menuGroupSn != 1){
								cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-lv='2'><span class='slider round'></span>";
							}else{
								if(authCode == 'ROLE_ADMIN'){
									cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-lv='2' disabled><span class='slider round'></span>";	
								}else{
									cHtml += "";
								}
							}
						cHtml += "</label>";
						cHtml += "</td>";
					}else{
						cHtml += "<td  class='authTd'>";
						cHtml += "<label class='switch'>";
							if(value.menuGroupSn != 1){
								cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-lv='2' checked><span class='slider round'></span>";
							}else{
								if(authCode == 'ROLE_ADMIN'){
									cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-lv='2' checked disabled><span class='slider round'></span>";	
								}else{
									cHtml += "";
								}
							}
						cHtml += "</label>";
						cHtml += "</td>";
					}
					cHtml += "	<td>&nbsp;&nbsp;<i class='fas fa-fw fa-angle-right'></i>"+value.menuGroupNm+" > "+value.menuNm+"</td>";
				
					if(value.isLast == 'N'){
						cHtml += fn_trList2(item, value.menuSn, authCode);
					}

					cHtml += "</tr>";
				}
			
			});
			
			return cHtml;
		}


		function fn_trList2(item, menuSn, authCode){
			
			var cHtml = "";
			
			$.each(item, function(index, value) {
				
				if(menuSn == value.upperMenuSn){
					
					cHtml += "<tr>";
					
					if(value.authAt != 'Y'){
						
						cHtml += "<td  class='authTd'>";
						cHtml += "<label class='switch'>";
							if(value.menuGroupSn != 1){
								cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-upperMenuSn="+value.upperMenuSn+" data-lv='3'><span class='slider round'></span>";
							}else{
								if(authCode == 'ROLE_ADMIN'){
									cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-upperMenuSn="+value.upperMenuSn+" data-lv='3' disabled><span class='slider round'></span>";	
								}else{
									cHtml += "";
								}
							}
						cHtml += "</label>";
						cHtml += "</td>";
					}else{
						cHtml += "<td  class='authTd'>";
						cHtml += "<label class='switch'>";
							if(value.menuGroupSn != 1){
								cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-upperMenuSn="+value.upperMenuSn+" data-lv='3' checked><span class='slider round'></span>";
							}else{
								if(authCode == 'ROLE_ADMIN'){
									cHtml += " 	<input type='checkbox' class='chkItem' data-menuGroupSn="+value.menuGroupSn+" data-menuSn="+value.menuSn+" data-upperMenuSn="+value.upperMenuSn+" data-lv='3' checked disabled><span class='slider round'></span>";	
								}else{
									cHtml += "";
								}
							}
						cHtml += "</label>";
						cHtml += "</td>";
					}
					cHtml += "	<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class='fas fa-fw fa-angle-double-right'></i>"+ value.menuGroupNm +" > "+ value.upperMenuNm +" > " + value.menuNm +"</td>";
					
					
					cHtml += "</tr>";
				}
			});
			
			return cHtml;

		}

		function fn_saveAuth(){
			
			var arr = [];
			var authCode = $("#authNm").text();
			var selectd = $('#authList').children('tr').children('td').children('label.switch').children('.chkItem');
			var nowAuthAtCnt = 0;
			
			selectd.each(function() {
				var obj = {};
				
				if($(this).attr("data-menuSn") != undefined){
					
					if($(this).is(":checked")){
						obj.menuSn = $(this).attr("data-menuSn");
						obj.useAt = 'Y';
						arr.push(obj);
					}else{
						obj.menuSn = $(this).attr("data-menuSn");
						obj.useAt = 'N';
						arr.push(obj);
					}
				}
				
			});
			
			
			if(arr == ""){
				alert("권한 코드를 선택해 주세요.");
				return false;
			}
			
			if(!authChk){
				alert("변경된 내용이 없습니다.");
				return false;
			}
			
			if(confirm("메뉴 권한을 변경하시겠습니까?")) {
				$.ajax({
					url : "/mngr/menuMng/saveAuthMenuList",
					method : "POST",
					data : {"authCode" : authCode, "updateArray" : JSON.stringify(arr)},
					success : function(data) {
						alert("저장 되었습니다.");
						//location.reload(true);
						fn_authList(authCode);
					}
				});	
			}
		}


		</script>
	</div>
</html>
