<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MSSQL.AnalysisMapper">

	<resultMap id="columnMap" type="Map">
		<result property="owner" column="OWNER"/>
        <result property="columnName" column="column_name"/>
        <result property="dataType" column="data_type"/>
        <result property="dataLength" column="data_length"/>
        <result property="dataPrecision" column="data_precision"/>
        <result property="dataScale" column="data_scale"/>
        <result property="nullable" column="nullable"/>
        <result property="dataDefault" column="data_default" jdbcType="CLOB" javaType="java.lang.String"/>
        <result property="lowValue" column="low_value"/>
        <result property="highValue" column="high_value"/>
        <result property="comments" column="comments"/>
    </resultMap>
    
    <resultMap id="tableMap" type="Map">
    	 <result property="tableName" column="table_name"/>
        <result property="numRows" column="num_rows"/>
        <result property="avgRowLen" column="avg_row_len"/>
        <result property="comments" column="comments"/>
        <result property="pkCnt" column="pk_cnt"/>
        <result property="indexCnt" column="index_cnt"/>
    </resultMap>


	<select id="selectTableAnalysisTotalCnt" parameterType="map" resultType="int">
		
		SELECT COUNT(*) AS CNT
		FROM (
				SELECT 
					A.TABLE_NAME
				FROM INFORMATION_SCHEMA.COLUMNS A 
				WHERE 
					A.TABLE_CATALOG = #{tableSchema}		
				GROUP BY A.TABLE_NAME
		) B
	</select>
	
	<select id="selectTableAnalysis" parameterType="map" resultType="map">
		SELECT
			*
		FROM
			(
			SELECT
				T1.*, ROW_NUMBER() OVER(ORDER BY (SELECT 1)) AS RNUM
			FROM
				(
				SELECT 
					A.TABLE_NAME AS tableName
					, PA.ROWS AS numRows
					, AVG(ISNULL(CAST(A.CHARACTER_MAXIMUM_LENGTH AS BIGINT), 0) ) AS avgRowLen
					, MAX(PA.INDEX_ID) AS indexCnt
					, ISNULL(COLUMNKEYCNT,0) AS pkCnt
					, C.VALUE AS comments
				FROM INFORMATION_SCHEMA.COLUMNS A 	
					LEFT OUTER JOIN
					(SELECT F.TABLE_NAME
						, F.TABLE_CATALOG
						, COUNT(F.TABLE_NAME) COLUMNKEYCNT
						FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE F
						WHERE F.TABLE_CATALOG = #{tableSchema}
						GROUP BY F.TABLE_NAME, F.TABLE_CATALOG
					) B
					ON A.TABLE_NAME = B.TABLE_NAME
					LEFT OUTER JOIN 
					(SELECT OBJECT_ID(OBJNAME) AS TABLE_ID, VALUE
						FROM ::FN_LISTEXTENDEDPROPERTY(NULL, 'USER','DBO','TABLE', NULL, NULL, NULL)
					) C
					ON OBJECT_ID(A.TABLE_NAME) = C.TABLE_ID
					INNER JOIN SYS.PARTITIONS PA
					ON PA.OBJECT_ID = OBJECT_ID(A.TABLE_NAME)
				WHERE 
					A.TABLE_CATALOG = #{tableSchema}		
				GROUP BY A.TABLE_NAME, C.VALUE ,PA.ROWS, B.COLUMNKEYCNT, PA.INDEX_ID
				) T1
			) T3
		WHERE 1=1		
	   <if test='tableAll != "1"'>
	    AND RNUM BETWEEN #{start_row} AND #{end_row}
	    </if>  
	</select>
	
	<select id="selectSchema" resultType="map">
		SELECT
		    CATALOG_NAME AS OWNER
		FROM 
			INFORMATION_SCHEMA.SCHEMATA
	        GROUP BY CATALOG_NAME
	</select>
	
	<select id="selectTable" resultType="map">
		SELECT
			TABLE_NAME AS TABLENAME
		FROM
			INFORMATION_SCHEMA.TABLES
		WHERE
			TABLE_CATALOG = #{tableSchema}
	</select>
	
	<select id="selectColumnAnalysis" parameterType="map" resultType="map">
		SELECT  
			A.COLUMN_NAME AS columnName
			, A.TABLE_CATALOG as tableSchema
			, A.DATA_TYPE AS dataType
			, A.CHARACTER_MAXIMUM_LENGTH AS dataLength
			, A.NUMERIC_PRECISION AS dataPrecision 
			, A.NUMERIC_SCALE AS dataScale 
			, A.IS_NULLABLE AS nullable
			, A.COLUMN_DEFAULT AS dataDefault
			, B.VALUE AS comments
			, A.TABLE_NAME AS tableName
		FROM INFORMATION_SCHEMA.COLUMNS A
			LEFT OUTER JOIN 
			SYS.EXTENDED_PROPERTIES B 
			ON B.MAJOR_ID = OBJECT_ID(A.TABLE_NAME)
			AND A.ORDINAL_POSITION = B.MINOR_ID
		WHERE TABLE_NAME = #{tableName}
		AND NOT A.DATA_TYPE IN ('TEXT')
		ORDER BY ORDINAL_POSITION
	</select>
	
	
	<select id="selectDualCheck" parameterType="map" resultType="int">
		SELECT
		    COUNT(1) AS CNT
		FROM INFORMATION_SCHEMA.SCHEMATA
	</select>
	
	<select id="selectCheckPatten" parameterType="map" resultType="int">
		SELECT
		    COUNT(1) AS CNT
		FROM INFORMATION_SCHEMA.SCHEMATA
		WHERE #{checkText} LIKE '%'#{analsFrmla}'%'
	</select>
	
	<select id="checkCsvColumnNm" parameterType="map" resultType="string">
		SELECT  
			COLUMN_NAME AS columnName
		FROM INFORMATION_SCHEMA.COLUMNS  
		WHERE TABLE_NAME = #{tables}
		AND COLUMN_COMMENT = #{comments}
	</select>
	
	<select id="selectCheckSql" parameterType="map" resultType="int">
		SELECT 
		COUNT(1) AS CNT
		FROM ${tables}
		WHERE ${analsFrmla}
	</select>
	
	<select id="selectMaxVal" parameterType="map" resultType="String">
		SELECT 
			MAX(${columnName})
		FROM ${tableName}
	</select>
	
	<select id="selectMinVal" parameterType="map" resultType="String">
		SELECT 
			MIN(${columnName})
		FROM ${tableName}
	</select>
	
	<select id="selectMinMaxVal" parameterType="map" resultType="map">
		SELECT 
			${columnName}
		FROM ${tableName}
	</select>
	
	<select id="selectTableAnalysisTotalColCnt" parameterType="map" resultType="int">
		SELECT 
			COUNT(1)
		FROM(
			SELECT 
				${columnName}
			FROM ${tableName}
		) A
	</select>
	
	<select id="selectTableAnalysisMtchgCnt" parameterType="map" resultType="int">
		SELECT 
			COUNT(1)
		FROM(
			SELECT 
				${columnName}
			FROM ${tableName}
			WHERE ${columnName} IS NOT NULL
		) A
			${whereParam}<![CDATA[>=]]>#{chkDate}
	</select>
	
	<select id="selectTableAnalysisMissCnt" parameterType="map" resultType="int">
		SELECT 
			COUNT(1)
		FROM(
			SELECT 
				${columnName}
			FROM ${tableName}
			WHERE ${columnName} IS NOT NULL
		) A
		${whereParam}<![CDATA[<]]>#{chkDate}
	</select>
</mapper>
