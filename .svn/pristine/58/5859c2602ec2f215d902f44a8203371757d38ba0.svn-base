<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
<style type="text/css">
	.tb_type99 { width : 100% !important }
	
	.table-layout { table-layout : inherit}
	.tb_type99 .tui-grid-cell { width : 50% }
	.tui-column-chart { display : inline-block; width: 50% !important;}
	.tui-bar-chart { display : inline-block; width: 50% !important;}
	.tui-pie-chart { display : inline-block; width: 50% !important;}
	/* .tui-bar-chart { display : inherit } */
	.tui-grid-rside-area {width : 100% !important}
	.tui-grid-body-container {width: 100% !important;}	
	.tui-grid-body-container > .tui-grid-table-container > .tui-grid-table {width: 100%;}
</style>
</head>

	<div layout:fragment="content">
		<!-- 상단 내비 / 타이틀 -->
		<div class="location">
			<ul>
	           <li class="home">home</li>
	            <li>BASIC</li>
	            <li>데이터 Lifecycle 관리</li>
	            <li><label th:text="#{UIT0564}">Lifecycle 분석 결과</label></li>
  	         </ul>
		</div>
		<!-- 영역 -->
		<div class="row">
			<div class="col-lg mb-4">
				<div class="card shadow mb-4">
					<div class="card-body">
						<span class="mb-0 text-gray-600">
							<i class="fas fa-square" style="float:left; margin-right:5px;font-size:16px; color:#4e73df; "></i><h3  th:text="#{UIT0376}">분석 개요</h3>
						</span>
						<div class="input_table" style="border: none; padding: 0 50px;">
							<table>
								<tbody id= "profilingResult">
									
								</tbody>
							</table>
						</div>
					</div>	
				</div>

				<form id="frm1" name="frm1" action="download/report.do" method="get">
					<input type="hidden" name="dgnssDbmsId" th:value="${schema.dgnssDbmsId}" />
					<input type="hidden" name="dgnssInfoId" th:value="${schema.dgnssInfoId}" />
				</form>

				<form id="frm2" name="frm2" action="download/notMatch.do" method="get">
					<input type="hidden" name="dgnssDbmsId" th:value="${schema.dgnssDbmsId}" />
					<input type="hidden" name="dgnssInfoId" th:value="${schema.dgnssInfoId}" />
					<input type="hidden" name="tableNm"  th:value="${schema.schemaNm}" />
					<input type="hidden" id="matchMm" name="matchMm" value="" />
				</form>

				<!-- 내용 -->
				<div class="card shadow mb-4 margint10">
					<div class="card-body">
						<i class="fas fa-square" style="float:left; margin-right:5px; font-size:16px; color:#4e73df;"></i><h3  th:text="#{UIT0378}">분석 결과</h3>
						<div style="clear: both"></div>
						<div style="margin-left:50px;">
							<form id="frm" name="frm" action="lifecycleResultView.do" method="get">
								<input type="hidden" name="dgnssDbmsId" th:value="${schema.dgnssDbmsId}" />
								<input type="hidden" name="dgnssInfoId" th:value="${schema.dgnssInfoId}" />
								<input type="hidden" name="pageIndex" value="" th:value="${param.pageIndex}" />
								<input type="hidden" id="itemsPerPage" name="itemsPerPage" value="1" />
							</form>
							<div class="input_table" style="border: none; padding: 0 50px;">
							</div>
							<div id="summeryGrid" class='tb_type99' style=' float:left; vertical-align:top;'></div>
							<!-- <div id="summeryGrid2" class='tb_type99' style=' float:left; vertical-align:top;'></div> -->
							<div id="tableResGrid" class='tb_type99' style=' float:left; vertical-align:top;'></div>
						</div>
						<div id="pagination" class="tui-pagination"></div>
					</div>
				</div>
			</div>
		</div>
					

		<div id="noMatchModal" class="modal fade" tabindex="-1" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="download-title"  th:text="#{UIT0379}">불일치 정보 다운로드</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <p id="downloadmsg" style="text-align:center;"  th:text="#{UIT0380}">다운로드 형식을 선택하세요.</p>
		      </div>
		      <div class="modal-footer">
		      	<button type="button" onclick="javascript:fn_modalClose();" class="btn btn-primary"  id="downloadclose"  th:text="#{UIT0221}">확인</button>
		        <button type="button" onclick="downloadNotMatch('csv')" class="btn btn-primary" id="csvDown">CSV</button>
		        <button type="button" onclick="downloadNotMatch('xlsx')" class="btn btn-success" id="excelDown">Excel</button>
		      </div>
		    </div>
		  </div>
		</div>
		<iframe name="hiddenFrame" hidden="" width="0" height="0"></iframe>

		<!-- TUI 차트 js -->
		<script th:src="@{/js/tui/core.js}"></script>
		<script th:src="@{/js/tui/raphael.js}"></script>
		<script th:src="@{/js/tui/tui-chart.js}"></script>
		
		<!-- Page level plugins -->
		<script th:src="@{/vendor/chart.js/Chart.min.js}"></script>

		<script type="text/javascript"  class="code-js" th:inline="javascript">
		
		/*<![CDATA[*/
	 	var UIT0041 = /*[[ #{UIT0041} ]]*/; //: 처리중 에러가 발생하였습니다
	 	var UIT0055 = /*[[ #{UIT0055} ]]*/; //: 접속 DBMS
	 	var UIT0367 = /*[[ #{UIT0367} ]]*/; //: 작업명
	 	var UIT0379 = /*[[ #{UIT0379} ]]*/; //: 불일치 정보 다운로드
	 	var UIT0381 = /*[[ #{UIT0381} ]]*/; //: 데이터베이스
	 	var UIT0382 = /*[[ #{UIT0382} ]]*/; //: 작업 시작 시간
	 	var UIT0383 = /*[[ #{UIT0383} ]]*/; //: 테이블
	 	var UIT0384 = /*[[ #{UIT0384} ]]*/; //: 작업 수행 시간
	 	var UIT0385 = /*[[ #{UIT0385} ]]*/; //: 접속 파일명
	 	var UIT0386 = /*[[ #{UIT0386} ]]*/; //: 일치 정보 다운로드
	 	var UIT0387 = /*[[ #{UIT0387} ]]*/; //: 패턴
	 	var UIT0388 = /*[[ #{UIT0388} ]]*/; //: 사용자정의
	 	var UIT0389 = /*[[ #{UIT0389} ]]*/; //: 항목
	 	var UIT0390 = /*[[ #{UIT0390} ]]*/; //: 기본패턴
	 	var UIT0391 = /*[[ #{UIT0391} ]]*/; //: 다운로드 대상 분석 정보가 없습니다.
		var columnData = /*[[${columnData}]]*/;		
		var column = /*[[${column}]]*/;
		var columnData = /*[[${columnData}]]*/;
		var tableList = /*[[${tableList}]]*/; 
		var resultData =   /*[[${bodyMap}]]*/;
		var frqListAll = /*[[${frqlList}]]*/;
		var columnCmt = /*[[${columnCmt}]]*/;
		var csvAt = /*[[${csvAt}]]*/;
		var listCntPerPage = /*[[${listCntPerPage}]]*/;
		var dbms = /*[[${dbms}]]*/; //DB정보
		var schema = /*[[${schema}]]*/; //schema 정보
		var summery = /*[[${summery}]]*/; //summery 정보
		var wordObsryList = /*[[${wordObsryList}]]*/; //wordObsryList 정보
		var domainObsryList = /*[[${domainObsryList}]]*/; //domainObsryList 정보
		var tableRes = /*[[${tableRes}]]*/; //tableRes 정보
		var tableResList = /*[[${tableResList}]]*/; //tableResList 정보
		var summeryRate = /*[[${summeryRate}]]*/; //summeryRate 정보
		/*]]*/


		
		var checkBtn = false;
		
		$(function() {


			//var list = resultData.body;
			$('#itemsPerPage').val(listCntPerPage);
			
			var startTr = "<tr style='border-bottom: 1px solid #e3e6f0;'>";
			var endTr= "</tr>";
			var innerTable = "";

			//DB 분석 후 결과 출력 시 
			// 첫번째
			innerTable += startTr;
			innerTable += "<td><label>"+UIT0381+"</label></td>";
			innerTable += "<td><input type='text' class='' value='"+schema.schemaNm+"' style='border:none; background-color: #fff' disabled></td>";
			innerTable += "<td><label>"+UIT0367+"</label></td>";
			innerTable += "<td><input type='text' class='' value='"+schema.dgnssNm+"' style='border:none; background-color: #fff; width: 100%;' disabled></td>";
			innerTable += endTr;
			
			// 두번째
			innerTable += startTr;
			innerTable += "<td><label>"+UIT0382+"</label></td>";
			innerTable += "<td><input type='text' class='' value='"+schema.excBeginTime+"' style='border:none; background-color: #fff' disabled></td>";
			innerTable += "<td><label>"+UIT0384+"</label></td>";
			innerTable += "<td><input type='text' class='' value='"+schema.workTime+"' style='border:none; background-color: #fff' disabled></td>";
			innerTable += endTr;
			
			$("#profilingResult").append(innerTable);
					
			
			//수정 예정
			summeryGrid();
			tableResGrid();
			chartView();
			//girdView();
			//wordObsryGrid();
			//domainObsryGrid();
			
			//freqView();
			
			tableResChartView();
			cntGrid();
		
			/* 페이징 function 호출 */
			/* $('#pageIndex').val($('#frm').find('input[name=pageIndex]').val()); // 페이지 초기에 pageIndex 파라메터 값을 전달
			$('#itemsPerPage').val($('#frm').find('input[name=itemsPerPage]').val());
			fn_pagination(tableList.length); */
		});
		
		function summeryGrid(){
			
			var idx = 0;
			var data = [];
			var columns = [
				{header: "항목", 	name: 'object',  align: 'center'},			
				{header: "대상 건수",  name: 'objectCnt', align: 'center'}, 
				];
			
			
			var html ="";
				html += "<strong style='display:none;'>* 요약 정보 </strong>";
				html += "<div id='summery' style= 'margin-bottom:30px; width: 50%; display:inline-block; float: left;'>";
				html += "<div id='chart' style= 'margin-bottom:30px; '>";
				html += "</div>";
				html += "</div>";
				html += "<br/><br/>";
			
			$("#summeryGrid").append(html);
			
			
			$.each(summery, function(index,value){
			var inputData = {};
			inputData.object = summery[idx].object;
			inputData.objectCnt =summery[idx].objectCnt;
			
			inputData._attributes = "{className: {column: {name: ['headB']}}}";

			idx++;
			data.push(inputData);
			
			});
			var  summeryGrid = new tui.Grid({
		           el : document.getElementById("summery"),
		           data : data,
		           scrollX : false,
		           scrollY : false,
			       	rowHeight : 40,
					minBodyHeight: 'auto',
					header: {
					  height: 50
					},
		           columns : columns
		     });
		     
		     var extOptions = {
		           cell: {
		                focused: {
		                 border: 0 // 선택 셀 강조 표시 x
		             }
		           }
		     };
		     
		     tui.Grid.applyTheme('default', extOptions);
			 
		}
			
		function tableResGrid(){
			
			var idx=0;
			var count = 0;
			var count2 = 0;
			var arrNumber = "";
			var i = 0;
			
			 	$.each(tableRes, function(index,value){

		    		var chk = 0; 
		    		
					var data = [];
					var html = "";
						html += "<div id='grid_"+count+"' class='tb_type99 margint10 marginb10' ></div>";
						html += "<div id='tableRes_"+count+"' style= 'margin-bottom:30px; display:inline;'>";
						html += "<div id='gc_div_"+count+"' style= 'margin-bottom:30px;'>";
						html += "<div id='cntGrid_"+count+"' style='width: 50% !important; float: left; margin-top: 60px;' class='tb_type99' >";
						html += "</div>";
						html += "<div id='chart_"+count+"' style= 'margin-bottom:30px; '>";
						html += "</div>";
						html += "</div>";
						
					html += "<br/><br/>";
					$("#tableResGrid").append(html);
					
					var columns = [
						{header: "테이블명", 	name: 'tableNm', align: 'center'},			
						{header: "기준 컬럼",  name: 'coulumnNm', align: 'center'},
						{header: "적용 항목",  name: 'fieldNm', align: 'center'}
					];

					var inputData = {};
						
					inputData.tableNm = tableRes[idx].tableNm;
					inputData.coulumnNm =tableRes[idx].coulumnNm;
					inputData.fieldNm =tableRes[idx].fieldNm;
		
					inputData._attributes = "{className: {column: {name: ['headB']}}}";
					
					data.push(inputData);
					
					chk ++;
					
					idx++;
				
					var id =  document.getElementById('grid_'+count);
					
					var grid = new tui.Grid({
						el : id,
						data : data,
						scrollX : false,
						scrollY : false,
						rowHeight : 40,
						minBodyHeight: 'auto',
						header: {
						  height: 50
						},
						columns : columns
					});

					var extOptions = {
						cell: {
							focused: {
								border: 0 // 선택 셀 강조 표시 x
							}
						}
					};
					tui.Grid.applyTheme('default', extOptions);
	
				
					$('#columnNM_'+count).show();
					$('#gc_div_'+count).prev('strong').show();
					id.style.display='inline-block';	
					
	
					count ++;						
		
				});  
			 
		}
		
		function cntGrid(){
			var idx = 0;
			
			var columns = [
				{header: "항목", 	name: 'object', align: 'center'},			
				{header: "대상건수",  name: 'objectCnt', align: 'center'} 
				];
			
			 $.each(tableRes, function(index,value){
		
			 var data = [];
			 for(var i = 0 ; i < tableResList.length; i++){
				 
				var inputData = {};
				if(tableResList[i].tableNm == tableRes[idx].tableNm){
					inputData.object = tableResList[i].object;
					inputData.objectCnt = tableResList[i].objectCnt;
					
					inputData._attributes = "{className: {column: {name: ['headB']}}}";
					
					data.push(inputData); 
				}	
				
			} 
			idx++;
			
			 var  cntGrid = new tui.Grid({
		           el : document.getElementById('cntGrid_'+(idx-1)),
		           data : data,
		           scrollX : false,
		           scrollY : false,
			       	rowHeight : 40,
					minBodyHeight: 'auto',
					header: {
					  height: 50
					},
		           columns : columns
		     });
		     
		     var extOptions = {
		           cell: {
		                focused: {
		                 border: 0 // 선택 셀 강조 표시 x
		             }
		           }
		     };
		     
		     tui.Grid.applyTheme('default', extOptions); 
			 });
		}
		
		function chartView() {
			var chart_id = document.getElementById("summeryGrid");
       		var data = {};
			var seriesData = {};
			var misSeriesData = {};
			var errSeriesData = {};
		
			data.categories = [];
			data.series = [];
			seriesData.data = {};
			misSeriesData.data = {};	
			errSeriesData.data = {};	
			
			if(summeryRate.length > 0){
				seriesData.name ='정상 건수';
				seriesData.data = summeryRate[0].mtchgPer;
					
				misSeriesData.name ='초과 건수';
				misSeriesData.data = summeryRate[0].missPer;
				
				errSeriesData.name ='에러 건수';
				errSeriesData.data = summeryRate[0].errPer;
				
				data.series.push(seriesData);
				data.series.push(misSeriesData);
				data.series.push(errSeriesData);
				
			}else{
				// 데이터가 없을때 설정
				data = {series: [{name: '정상 건수',data: 0},{name: '초과 건수',data: 0},{name: '에러 건수',data: 0}]}
			}
			var options = {
				    chart: {width: 350, height: 300},
				    series: {radiusRange: ['35%', '100%'], showLabel: true},
				    tooltip: {suffix: '%'},
				    legend: {align: 'top'},
				    chartExportMenu: {visible: false},
					legend: {visible: true,	showCheckbox: false}
				};
			
			var theme = {
			    series: {
			        series: {
			            colors: [
			            	'#03b3f8', '#FFB840', '#ec340e'
			            ]
			        },
			        label: {
			            color: '#F9F9F9',
			            fontFamily: 'sans-serif'
			        }
			    },
			    chart: {
			        fontFamily: 'Verdana',
			        background: {
			            color: '#343434',
			            opacity: 1
			        }
			    },
			    legend: {
			        label: {
			            fontSize: 14,
			            fontFamily: 'Verdana',
			            fontWeight: 'bold',
			            color: '#F9F9F9'
			        }
			    }
			};

			tui.chart.pieChart(chart_id, data, options);
		} 
	
		function tableResChartView() {
			var chartData = {};	//Root
			var series = [];	//Depth2
			var seriesDetail = {};	//Depth3
			var options;
			var arrNumber = "";
			var count = 0;
			var idx = 0;

			$.each(tableRes, function(index,value){
				
				var data = {};
				var seriesData = {};
				var chart_id = document.getElementById("chart_"+count);
				//var chk = 0;
				
				data.categories = [];
				data.series = [];
				
				seriesData.name ='Value';
				seriesData.data = [];
				
		        for(var i = 0; i < tableResList.length; i++){
		        	
		        	if(tableResList[i].tableNm == tableRes[idx].tableNm){
						var dataVal = tableResList[i].object;
						data.categories.push(dataVal);			
						seriesData.data.push(tableResList[i].objectCnt);
		        	}
					//chk ++;
		        }
				idx ++;
		        data.series.push(seriesData);

		        //if(chk > 0 && data != null){   
		        options = {
		                chart: {width: 600,height: 300 },
		                yAxis: {title: 'Value' },
		                xAxis: {title: 'Data' },
		                chartExportMenu: {visible: false },
						legend: {visible: false }
		            };
		        
				tui.chart.columnChart(chart_id, data, options);
				//chart_id.style.display  = 'inline-block';
				count++;
		       //}
	        });
		}	
		
		function fn_search() {
			$('#frm').find('input[name=pageIndex]').val($('#pageIndex').val()); // 페이지 전환 전 pageIndex 폼에 전달
			$('#frm').find('input[name=itemsPerPage]').val($('#itemsPerPage').val());
			$('#frm').submit();
		}
			
		function downloadNotMatch(type) {
			$('#frm2 > #fileType').val(type);
			$('#frm2').submit();
			fn_modalClose();
		}
			
			
		function infoDown(col, data){
			if(checkBtn==false){
				// 모달창 버튼 메시지 처리
				$('#downloadclose').show();
				$('#csvDown').hide();
				$('#excelDown').hide();
 			    $('#downloadmsg').text(UIT0391);
			}else{
				var val = data.value;
				var colnm = $('#colNm_'+col).val();
				$('#matchMm').val(val);				
 			    $('#columnNm').val(colnm);
 			    // 모달창 버튼 메시지 처리
 			    $('#excelDown').show();
 			    $('#downloadclose').hide();
 			    $('#downloadmsg').text(UIT0380);
 			    
				if(val != 'mis'){
					$('#download-title').text(UIT0386);
					$('#csvDown').show();
				}else{
					$('#download-title').text(UIT0379);
					$('#csvDown').show();
				} 
			}
		}
		</script>
	</div>
</html>