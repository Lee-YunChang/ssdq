<%@ page contentType="text/html; charset=utf-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html lang="ko">
	<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title><c:if test="${not empty title}">${title} &lt;</c:if> :: 상상스토리  - DQ ::</title>

	<!-- 폰트 -->
	<link href="/resources/vendor/fontawesome-free/css/all.css" rel="stylesheet" />
	<!-- Admin Bootstrap 스타일시트 -->
	<link href="/resources/css/sb-admin-3.css" rel="stylesheet" />
	<!-- TUI 스타일시트 -->
	<link href="/resources/css/tui/tui-grid.css" rel="stylesheet" />
	<!-- jquery ui -->
	<link href="/resources/css/jquery-ui.css" rel="stylesheet">
	<!-- Sub -->
	<link href="/resources/css/sub.css" rel="stylesheet">

	<!-- TUI 스크립트 -->
	<script type="text/javascript" src="/resources/js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="/resources/js/jquery-ui.js"></script>
	<script type="text/javascript" src="/resources/js/tui/underscore.js"></script>
	<script type="text/javascript" src="/resources/js/tui/backbone.js"></script>
	<script type="text/javascript" src="/resources/js/tui/tui-code-snippet.js"></script>
	<script type="text/javascript" src="/resources/js/tui/tui-grid.js"></script>
	<script type="text/javascript" src="/resources/js/common.js"></script>
	<script type="text/javascript" src="/resources/js/tui/tui-pagination.js"></script>
	<!-- Bootstrap 스크립트 -->
	<script src="/resources/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="/resources/vendor/jquery-easing/jquery.easing.min.js"></script>
	<!-- Admin Bootstrap 스크립트 -->
	<script src="/resources/js/sb-admin-2.js"></script>
	</head>
	
	<body id="page-top" style="overflow-x:hidden; overflow-y:hidden;">
		<div id="wrapper">
			<!-- Content Wrapper -->
			<div id="content-wrapper" class="d-flex flex-column">
				<!-- 메인 -->
				<div id="content">
					<!-- 본문 -->
					<div class="container-fluid">
						<!-- 영역 -->
						<div class="row">
							<div class="col-lg mb-4">
								<form id="frm" name="frm" action="../form2.do" method="get">
									<input type="hidden" name="schemaName" value="${param.schemaName}" />
									<input type="hidden" name="tableName" value="${param.tableName}" />
									<div id="hiddenDiv"></div>
									
									<div class="card shadow mb-4">
										<div class="card-body">
											<div class="modal-header">
												<h5 class="modal-title" id="example">프로파일링 분석 </h5>
												<button type="button" class="btn btn-primary btn_wd100" onclick="goForm2();">확인</button>
											</div>
											<div id="grid" class="tb_type99"></div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

<script>
var grid = null;
var colWidth = 120;

$(function() {
	girdView();
});

function girdView(){

	var columnName = [
		{header: '컬럼명', name: 'mergeColName', childNames: ['colName']},
<c:forEach var="item" items="${columnList}" varStatus="i">
		{
<c:choose>
	<c:when test="${csvAt}">
			header: '${item.COLUMN_COMMENT}',
	</c:when>
	<c:otherwise>
			header: '${item.COLUMN_NAME}',
	</c:otherwise>
</c:choose>
			name: 'merge${item.COLUMN_NAME}',
			childNames: ['${item.COLUMN_NAME}']
		}<c:if test="${not i.last}">,</c:if>
</c:forEach>
	];

	var columnType = [
		{header: '컬럼타입', name: 'colName', width: 100, align: 'center'},
<c:forEach var="item" items="${columnList}" varStatus="i">
		{
			header: '${item.DATA_TYPE}(${item.DATA_LENGTH})',
			name: '${item.COLUMN_NAME}',
			align: 'center'
		}<c:if test="${not i.last}">,</c:if>
</c:forEach>
	];

	var data = [
		{
			//colName: '선택',
			colName: '<input type="button" class="btn_select" value="전체선택"/>',
<c:forEach var="item" items="${columnList}" varStatus="i">
			${item.COLUMN_NAME}: '<input type="checkbox" value="${item.COLUMN_NAME}" />'<c:if test="${not i.last}">,</c:if>
			//${item.COLUMN_NAME}: '<label class="switch"><input type="checkbox" value="${item.COLUMN_NAME}" /><span class="slider round"></span></label>'<c:if test="${not i.last}">,</c:if>
</c:forEach>
		}<c:if test="${not empty dataList}">,</c:if>
<c:forEach var="row" items="${dataList}" varStatus="r">
		{
			colName: '',
	<c:forEach var="col" items="${columnList}" varStatus="c">
			${col.COLUMN_NAME}: '${fn:trim(row[col.COLUMN_NAME])}'<c:if test="${not c.last}">,</c:if>
	</c:forEach>
		}<c:if test="${not r.last}">,</c:if>
</c:forEach>
	];

	grid = new tui.Grid({
		el: document.getElementById("grid"),
		data: data,
		scrollX: false,
		scrollY: false,
		bodyHeight : 'auto',
		header: {
			height: 80,
			complexColumns: columnName
		},
//		columnOptions: {
//			frozenCount: 1
//		},
		columns: columnType
	});

	grid.on('click', function(ev) {

		var data = grid.getData();
		var colName = ev.columnName;

		if (colName == null) {
			return false;
		}

//		console.log(ev);
//		console.log(colName);

		if (colName == 'colName' || colName == 'mergeColName') {

			var chkboxList = data[0];
			var checked = null;

			for (var i in chkboxList) {

				if (i == '전체선택' || typeof chkboxList[i] != 'string') {
					continue;
				}

				var chkbox = $(chkboxList[i]);

				if (chkbox.length == 0) {
					continue;
				}

				if (checked == null) {
					checked = !chkbox.prop('checked');
				}

				chkbox.attr('checked', checked);
				chkboxList[i] = chkbox[0].outerHTML;
			}

		} else {

			var chkbox = $(data[0][colName]);

			if (chkbox.length == 0) {
				chkbox = $(data[0][colName.replace('merge', '')]);
			}

			chkbox.attr('checked', !chkbox.prop('checked'));
			data[0][colName] = chkbox[0].outerHTML;

		}

		grid.resetData(data);
		//grid.refreshLayout();

		return ev.stop();
	});

	const extOptions = {
		cell: {
			focused: {
				border: 0 // 선택 셀 강조 표시 x
			}
		}
	};

	tui.Grid.applyTheme('default', extOptions);

}

function goForm2() {

	var data = grid.getData();
	var val;

	$('#hiddenDiv').empty();

	for (var c in data[0]) {

		if (c == '전체선택' || typeof data[0][c] != 'string') {
			continue;
		}

		var chkbox = $(data[0][c]);

		if (!chkbox.prop('checked')) {
			continue;
		}

		val = chkbox.val();
		
		var check = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
		if(!check.test(val)){
			$('#hiddenDiv').append($('<input type="hidden" name="columnName" value="" />').val(val));	
		}

	}

	if ($('#hiddenDiv').html() == '') {
		alert('분석할 컬럼을 선택해 주세요.');
		return;
	}

	var frm = $('#frm');

	opener.name = "analysisWin";
	frm.attr('target', opener.name);
	frm.submit();
	self.close();
}
</script>

</html>