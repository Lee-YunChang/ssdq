<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
	<div layout:fragment="content">
	
		<!-- 상단 내비 / 타이틀 -->
		<div class="d-sm-flex align-items-center justify-content-between mgn_b0">
  			<span class="col_gray01 font_14 mgn_b0"><img src="/img/icon/icon_home.png" alt="집 아이콘" class="vtc_unset"> RULE &gt; 업무규칙 관리 &gt; 허용 값 범위 설정</span>
        </div>
	                
       	<div class="d-sm-flex align-items-center justify-content-between mb-4">
			<h1 class="col_grey font_23 font_slim"> 허용 값 범위 설정</h1>
        </div>
		
		<!-- 영역 -->
		<div class="row">
			<div class="col-lg mb-4">
			<!-- 내용 -->
			<div class="card shadow mb-4">
				<div class="card-body">
					<div id="dataTable_filter" class="dataTables_filter">
                          <section class="mgn_b20 txt_right">
                              <button class="btn btn-secondary btn_wd120" onclick="goList('list')" >목록보기</button>
                              <button class="btn btn-primary btn_wd100" id="btnSave" name="btnSave" onclick="saveLimit()">저장</button>
                          </section>
                          <form action="">
                          <input type="hidden" id="analsId" name="analsId" class=" " th:value="${analsId}">
                              <section class="l_box_type02">                                    
                                  <div class="tb_type03">
                                      <table>
                                          <tbody>
                                              <tr>                                                                
                                                  <th><span class="str">*</span> 허용 값 이름</th>
                                                  <td>
                                                      <input type="text" id="analsNm" name="analsNm" class=" " maxlength="30" th:value="${analsNm}">
                                                  </td>
                                                  
                                                  <th><span class="str">*</span> 허용 값 종류</th>
                                                  <td style="text-align: left;">
                                                      <select id="analsSe" name="analsSe" class="" style="width: 200px;" onchange="changeAnalsSe(this);">
                                                            <option value="AG000600">선택</option>
                                                        </select> 
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th><span class="str">*</span> FROM</th>
                                                    <td>
                                                        <input type="text" id="beginValue" name="beginValue" class=" " maxlength="20" th:value="${beginValue}" >
                                                        <input type="hidden" id="beginDate" name="beginDate" class=" " th:value="${beginValue}" readonly>
                                                    </td>
                                                    <th><span class="str">*</span> TO</th>
                                                    <td>
                                                        <input type="text" id="endValue" name="endValue" class=" " maxlength="20" th:value="${endValue}" >
                                                        <input type="hidden" id="endDate" name="endDate" class=" " th:value="${endValue}" readonly>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>설명</th>
                                                    <td colspan="3">
                                                        <textarea type="text" id="rm" name="rm" th:value="${rm}" th:text="${rm}"></textarea>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </form>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript" class="code-js">
		
		var sessionCon = /*[[ ${sessionCon} ]]*/;

			$(document).ready(function() {
				// sessionCon 체크
				isSessionConChk(sessionCon);
				
				selDbmsKindListBox();
				
				onAnalsSe();
				var analsId = "${analsId}";
				
				if(analsId > -1 && "" != analsId){
					$("#btnSave").text("수정");
				}
				
			});

			// 허용값종류 조회
			function selDbmsKindListBox(){
				var groupCode = 'AG000000';
				var analsSe = /*[[ ${analsSe} ]]*/;
				var sbStr = "";
				
				if(analsSe == null){
					analsSe = "AG000600";
				}
				
				$.ajax({
					url: '/mngr/ruleMng/selectCmmnList',
					method : 'POST',
					data: {groupCode : groupCode, cmmnCode : analsSe.substring(0,6)},
					success: function(dataList){
						
						$.each(dataList, function(index, value) {
							var selected = "";
							
							if(analsSe.trim() == value.analsSe){
								selected = "selected=true";
							}
							var option  = $("<option value="+value.analsSe+" "+selected+">"+value.analsSeNm+"</option>");
							$("#analsSe").append(option);
						})
						
			        }, error:function() {
		                alert("처리중 에러가 발생하였습니다");
		                return;
		           }
			    });
			}

			// 선택된 지정 DB 접속 정보를 세션에 등록한다.
			function saveLimit(){
				
				var analsSe = $("#analsSe").val(); // 분석 구분 AG000601, AG000602, AG000603
				var analsNm = $("#analsNm").val();
				var beginValue = $("#beginValue").val();
				var endValue = $("#endValue").val();
				var analsId = $("#analsId").val();
				var rm = $("#rm").val();
				
				if(analsSe == "AG000603"){
					beginValue = $("#beginDate").val();
					endValue = $("#endDate").val();
					//beginValue = beginValue.replace(/-/gi,'');
					//endValue = endValue.replace(/-/gi,'');
				}
				
				if(analsNm == "" || analsNm == null){
					alert("허용 값 이름을 반드시 입력해 주세요.");
					$("#analsNm").focus();
					return false;
				}
				
				if(analsSe == "AG000600" || analsSe == null){
					alert("허용 값 종류를 반드시 선택해 주세요.");
					$("#analsSe").focus();
					return false;
				}
				
				if(beginValue == "" || beginValue == null){
					alert("FORM를 반드시 입력해 주세요.");
					$("#beginValue").focus();
					return false;
				}

				if(endValue == "" || endValue == null){
					alert("TO를  반드시 입력해 주세요.");
					$("#endValue").focus();
					return false;
				}

				if(analsSe == "AG000601"){
					if(isNumber(beginValue)== false){
						alert('FORM 값은 숫자만 가능합니다.');
						$("#beginValue").focus();
						return false;
					}
					if(isNumber(endValue)== false){
						alert('TO 값은 숫자만 가능합니다.');
						$("#endValue").focus();
						return false;
					}

					if(isNumber(beginValue) > isNumber(endValue)){
						alert('TO 값은 FROM 값보다 작을 수 없습니다.');
						$("#endValue").focus();
						return false;
					}
				}

				if(analsSe == "AG000603"){
					if(TypeChecker.date(beginValue)== false){
						alert('FORM 값은 '+TypeChecker.dateText);
						//$("#beginValue").focus();
						return false;
					}
					if(TypeChecker.date(endValue)== false){
						alert('TO 값은 '+TypeChecker.dateText);
						//$("#endValue").focus();
						return false;
					}
					if(beginValue > endValue){
						alert('TO 값은 FROM 값보다 작을 수 없습니다.')
						//$("#endValue").focus();
						return false;
					}
				}
				console.log(beginValue + " : "+endValue);
				if(confirm("해당 정보를 등록 하시겠습니까?")){
					
					$.ajax({
						url: "/mngr/ruleMng/saveRuleLimit",
						data: {analsSe : analsSe, analsNm : analsNm, beginValue : beginValue, endValue : endValue, analsId : analsId, rm : rm},
						success: function(data){
							if(data == "true"){
								alert("정상적으로 등록되었습니다.");
								// 처리 완료시 페이지를 조회 페이지로 이동하여 등록 결과 목록을 확인 한다.
								location.href = "/mngr/analysis/analysisPatternList";
							}else{
								alert("처리중 에러가 발생하였습니다");
							}
							
						}, error:function() {
			                alert("처리중 에러가 발생하였습니다");
			                return;
			           }
					});
					
				}
			}


			function changeAnalsSe(){
				$("#beginValue").val("");
				$("#endValue").val("");
				$("#beginDate").val("");
				$("#endDate").val("");
				$("#beginValue").attr("type",'text');
				$("#endValue").attr("type",'text');
				$("#beginDate").attr("type",'hidden');
				$("#endDate").attr("type",'hidden');
				if($("#analsSe").val() == "AG000603"){
					$("#beginValue").attr("type",'hidden');
					$("#endValue").attr("type",'hidden');
					$("#beginDate").attr("type",'text');
					$("#endDate").attr("type",'text');
					$("#beginDate, #endDate").datepicker();
				}
			}

			function onAnalsSe(){
				if("${analsSe}" == "AG000603"){
					$("#beginValue").attr("type",'hidden');
					$("#endValue").attr("type",'hidden');
					$("#beginDate").attr("type",'text');
					$("#endDate").attr("type",'text');
					$("#beginDate, #endDate").datepicker();
				}
			}

			function isNumber(str){
				var src = new String(str);
				var tar = true;
				var i;
				var len = src.length;

				for (i=0; i < len; i++) {
					if((src.charAt(i) < '0') | (src.charAt(i) > '9')){
						if(i==0) {
							if(src.charAt(i) != '-') return false;
						}
						else {
							if(src.charAt(i) != '.') return false;
						}
					}
				}
				return true;
			}

			TypeChecker = function(){
				var number = /^-?[0-9]+,?[0-9]+\.?[0-9]+$/;
				var email = /^(\w+)([-+.][\w]+)*@(\w[-\w]*\.){1,5}([A-Za-z]){2,4}$/;    
				var url = /(((https?)|(ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;    
				var date = /^[0-9]{4}(-|\.)?[0-9]{2}(-|\.)?[0-3][0-9]$/;
				var ipAddres = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
				var pw = /^[a-zA-Z0-9+]{6,12}$/;
				var pwNum = /[0-9]/;
				var pwEng = /[a-zA-Z]/;

				return {
					'required' : function(v){
						return v.trim() != "";
					},
					'requiredText' : "반드시 입력해야 합니다.",
				
					'email' : function(v){            
						if(v.trim() == "") return true;
						return email.test(v);        
					},
					'emailText' : "Email 형식만 가능합니다. 예)user@example.com",
					'emailMask' : /[a-z0-9_\.\-@]/i,        
				
					'url' : function(v){
						if(v.trim() == "") return true;
						return url.test(v);        
					},        
					'urlText' : "URL 형식만 가능합니다. 예)http://www.example.com",        

					'alpha' : function(v){            
						if(v.trim() == "") return true;
						return alpha.test(v);        
					},
					'alphaText' : "알파벳만 가능합니다.",     		
					'alphaMask' : /[a-z_]/i,
					
					'alphanum' : function(v){            
						if(v.trim() == "") return true;
						return alphanum.test(v);        
					},
					'alphanumText'  :  "알파벳과 숫자만 가능합니다.",     		
					'alphanumMask' : /[a-z0-9_]/i,

					'number' : function(v){            
						if(v.trim() == "") return true;
						return number.test(v);        
					},
					'numberText'  : "숫자만 가능합니다.",     		
					'numberMask' : /^-?[0-9]+,?[0-9]+\.?[0-9]+$/i ,

					'date' : function(v){
						if(v.trim() == "") return true;
						return date.test(v);        
					},
					'dateText'  : "날짜만 가능합니다. 예)20090101",
					'dateMask' : /^[0-9]{4}(-|\.)?[0-9]{2}(-|\.)?[0-3][0-9]$/,

					"ip":  function(v) {
						if(v.trim() == "") return true;
						return ipAddress.test(v);
					},
					"ipText": 'IP주소만 가능합니다.',
					"ipMask": /[\d\.]/i

					,'pw': function(v) {
						if(v.trim()=="") return true;
						return (pw.test(v));
					}
					,'pwText' : "비밀번호는 6~12자리의 영문자와 숫자를 혼용해서 사용해야 합니다."
					
					,'pwNum': function(v) {
						if(v.trim()=="") return true;
						return (pwNum.test(v));
					}	
					,'pwEng': function(v) {
						if(v.trim()=="") return true;
						return (pwEng.test(v));
					}	
					,'pwTextNumEng' : "비밀번호는 영문자와 숫자를 혼용해서 사용해야 합니다."
						
				}
			}();

			function goList(type){
				location.href = "/mngr/analysis/analysisPatternList";
			}
			
		</script>
	</div>
</html>